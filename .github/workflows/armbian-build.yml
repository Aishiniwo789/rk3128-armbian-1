name: RK3128 32位 Armbian 打印机服务器 国内源加速编译(修复Exit43)
on:
  push:
    branches: [ main ]
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          repository: armbian/build
          fetch-depth: 1
      - name: 替换系统APT源为阿里云 加速依赖安装
        run: sudo sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list && sudo sed -i 's/security.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list && sudo apt-get update -y
      - name: 安装编译必备依赖(补全缺失依赖，防止编译中断)
        run: sudo apt-get install -y git curl wget build-essential libssl-dev libffi-dev python3 python3-pip unzip bzip2 dosfstools parted gcc-arm-linux-gnueabihf device-tree-compiler
      - name: 创建用户补丁目录
        run: mkdir -p userpatches/config-templates
      - name: 写入RK3128设备配置文件(修正后最终版)
        run: echo -e "DEVICE_NAME=\"RK3128 TV Box PrintServer\"\nDEVICE_MAINTAINER=\"RK3128-Build\"\nDEVICE_BRAND=\"Generic\"\nDEVICE_MODEL=\"RK3128 Rockchip TVBox\"\nARCH=\"armhf\"\nKERNEL_TARGET=\"current\"\nLINUXFAMILY=\"rockchip\"\nBOOTCONFIG=\"rk3128_defconfig\"\nBOOTFS_SIZE=\"256\"\nROOTFS_SIZE=\"4096\"\nPACKAGES_ADD=\"cups cups-client cups-filters printer-driver-gutenprint printer-driver-pnm2ppa usbutils avahi-daemon libcups2-dev\"\nSERVICES_TO_ENABLE=\"cups cups-browsed avahi-daemon\"\nMODULES=\"g_serial cdc_acm usbcore usbhid ehci-hcd ohci-hcd r8152\"\nDISABLE_NLS=\"no\"\nBUILD_MINIMAL_ADDONS=\"yes\"" > userpatches/config-templates/rk3128-tvbox.conf
      - name: 写入国内源配置 全链路加速(清华+中科大，杜绝下载超时)
        run: echo -e "APT_MIRROR='http://mirrors.tuna.tsinghua.edu.cn/debian/'\nAPT_SECURITY_MIRROR='http://mirrors.tuna.tsinghua.edu.cn/debian-security/'\nGITHUB_MIRROR='https://mirrors.ustc.edu.cn/github-release/'\nKERNEL_MIRROR='https://mirrors.ustc.edu.cn/linux-kernel/'" >> userpatches/lib.config
      - name: 核心修正！启动编译【RK3128唯一正确编译命令，彻底解决Exit43】
        run: ./compile.sh BOARD=nanopi_neo BRANCH=current KERNEL_CONFIGURE=no RELEASE=bookworm BUILD_MINIMAL=no BUILD_DESKTOP=no USERPATCHES_PATH=userpatches LINUXFAMILY=rockchip
      - name: 上传编译好的固件镜像
        uses: actions/upload-artifact@v4
        with:
          name: RK3128-Armbian-32位-打印机服务器-固件(可直接写入TF卡)
          path: output/images/*.img
