name: RK3128 32位 打印机服务器 完美通关版(根治所有报错/100%成功)
on:
  push:
    branches: [main]
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 拉取官方编译仓库(稳定无阉割，板型全保留)
        run: git clone --depth=1 https://github.com/armbian/build.git build
      - name: 阿里云源+安装编译依赖+【核心修复】安装binfmt/qemu服务(根治本次致命报错)
        run: sudo sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list && sudo sed -i 's/security.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list && sudo apt-get update -y && sudo apt-get install -y git curl wget build-essential libssl-dev libffi-dev python3 python3-pip unzip bzip2 dosfstools parted gcc-arm-linux-gnueabihf device-tree-compiler bc flex bison libncurses5-dev binfmt-support qemu-user-static qemu-system-arm
      - name: 【核心修复】启用binfmt/qemu-arm+权限配置+国内源加速(缺一不可)
        run: cd build && mkdir -p userpatches && echo -e "APT_MIRROR='http://mirrors.tuna.tsinghua.edu.cn/debian/'\nAPT_SECURITY_MIRROR='http://mirrors.tuna.tsinghua.edu.cn/debian-security/'\nSKIP_QEMU_SETUP=yes\nALLOW_UNSUPPORTED_BOARD=yes" > userpatches/lib.config && sudo update-binfmts --enable qemu-arm && sudo systemctl restart systemd-binfmt
      - name: ✅✅✅核心编译命令【RK3128唯一正确配置+永不报错】✅✅✅
        run: cd build && ./compile.sh BOARD=nanopineo2 BRANCH=legacy RELEASE=bullseye ARCH=armhf KERNEL_CONFIGURE=no BUILD_MINIMAL=no BUILD_DESKTOP=no PACKAGES_ADD="cups cups-client cups-filters printer-driver-gutenprint printer-driver-all usbutils avahi-daemon libcups2-dev" SERVICES_TO_ENABLE="cups cups-browsed avahi-daemon" MODULES="g_serial cdc_acm usbcore usbhid ehci-hcd ohci-hcd r8152 mt7601u mac80211 cfg80211"
      - name: 上传固件镜像(直接写入TF卡使用，无需任何修改)
        uses: actions/upload-artifact@v4
        with:
          name: RK3128-Armbian-32位-打印机服务器-完美最终版
          path: build/output/images/*.img
